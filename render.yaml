# Blueprint for deploying n8n on Render
# This file is now the single source of truth for your service's configuration.
# It is configured to connect to your EXISTING database named 'n8n-db-august'.

services:
  # This section defines your existing n8n web service.
  - type: web
    name: n8n-service # Matches your service name from the screenshot
    plan: free
    runtime: image
    image:
      url: docker.io/n8nio/n8n:latest

    # This 'databases' block explicitly links your web service
    # to your existing database. This is the key to making it work.
    databases:
      - name: n8n-db-august # Matches your database name from the screenshot
        property: connectionString # This tells Render to create the connection string

    # All non-secret configuration is now defined here.
    envVars:
      # --- Database Connection ---
      # This tells n8n to use a PostgreSQL database.
      - key: DB_TYPE
        value: postgresdb
      # These 'fromDatabase' keys automatically and securely pull the connection
      # details from the 'n8n-db-august' database linked above.
      - key: DB_POSTGRESDB_HOST
        fromDatabase:
          name: n8n-db-august
          property: host
      - key: DB_POSTGRESDB_DATABASE
        fromDatabase:
          name: n8n-db-august
          property: database
      - key: DB_POSTGRESDB_USER
        fromDatabase:
          name: n8n-db-august
          property: user
      - key: DB_POSTGRESDB_PASSWORD
        fromDatabase:
          name: n8n-db-august
          property: password

      # --- Webhook and Proxy Configuration (THE FIX FOR 403 ERROR) ---
      # This tells n8n its public URL, using your custom domain.
      - key: WEBHOOK_URL
        value: https://n8n.victorseda.xyz/

      # This tells n8n to trust the proxy headers from Render.
      - key: N8N_TRUST_PROXY
        value: "true"

      # --- Other Configuration from your Environment ---
      - key: GENERIC_TIMEZONE
        value: Africa/Lagos
      - key: NODES_EXTERNAL_MODULES
        value: n8n-nodes-scrapingbee
      - key: N8N_SECURE_COOKIE
        value: "true"
