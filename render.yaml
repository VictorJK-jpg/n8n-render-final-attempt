# Blueprint for deploying n8n on Render
# This file serves as the single source of truth for the service configuration.

services:
  # Defines the n8n web service
  - type: web
    name: n8n-service # This name is used to reference the service below
    plan: free # Can be upgraded to a paid plan for more resources
    runtime: image
    image:
      url: docker.io/n8nio/n8n:latest # Pulls the latest official n8n image

    # Environment variables are crucial for n8n's configuration
    envVars:
      # --- Database Connection ---
      # Tells n8n to use a PostgreSQL database
      - key: DB_TYPE
        value: postgresdb
      # These 'fromDatabase' keys automatically pull connection details
      # from the Render Postgres database defined at the end of this file.
      - key: DB_POSTGRESDB_HOST
        fromDatabase:
          name: n8n-database # Must match the name of the database service below
          property: host
      - key: DB_POSTGRESDB_DATABASE
        fromDatabase:
          name: n8n-database
          property: database
      - key: DB_POSTGRESDB_USER
        fromDatabase:
          name: n8n-database
          property: user
      - key: DB_POSTGRESDB_PASSWORD
        fromDatabase:
          name: n8n-database
          property: password

      # --- n8n Core Configuration ---
      # IMPORTANT: Set your encryption key directly in the Render Dashboard
      # and do NOT store it in this file for security reasons.
      # It's a secret that should not be in your public GitHub repo.
      # - key: N8N_ENCRYPTION_KEY
      #   value: "YOUR_SECRET_KEY_HERE" # <-- DO NOT DO THIS

      # Sets the timezone for cron-based triggers
      - key: GENERIC_TIMEZONE
        value: Africa/Lagos

      # --- Webhook and Proxy Configuration (THE FIX FOR 403 ERROR) ---
      # This is the most critical part for Render hosting.
      # It tells n8n its own public URL.
      - key: WEBHOOK_URL
        fromService:
          type: web
          name: n8n-service # Must match the name of this service
          envVarKey: RENDER_EXTERNAL_URL

      # This tells n8n to trust the proxy headers from Render.
      - key: N8N_TRUST_PROXY
        value: "true"

      # --- Optional but Recommended Settings ---
      # Enforces secure cookies, essential when not on localhost
      - key: N8N_SECURE_COOKIE
        value: "true"
      
      # Loads your desired community node
      - key: NODES_EXTERNAL_MODULES
        value: n8n-nodes-scrapingbee

  # Defines the Postgres database used by n8n
  - type: pserv
    name: n8n-database # This name is referenced by the web service above
    plan: free # Can be upgraded for more storage/performance
    databaseName: n8n_db # You can name the actual DB whatever you like
    databaseUser: n8n_user # You can name the user whatever you like
    postgresMajorVersion: 14 # Specify a version for consistency
